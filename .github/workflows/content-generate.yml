name: Weekly Blog Post Generation

on:
  schedule:
    # Every Monday at 08:00 UTC
    - cron: "0 8 * * 1"
  workflow_dispatch: # Allow manual trigger with options
    inputs:
      topic:
        description: "Blog post topic (leave empty for auto-select)"
        required: false
        default: "auto"
      model:
        description: "AI model to use"
        required: false
        default: "claude-haiku"
        type: choice
        options:
          - claude-haiku
          - gpt-5-nano
      publish:
        description: "Publish immediately?"
        required: false
        default: "false"
        type: choice
        options:
          - "false"
          - "true"

jobs:
  # Step 1: Start text generation (returns immediately, runs in background)
  generate-text:
    runs-on: ubuntu-latest
    timeout-minutes: 5
    outputs:
      job_id: ${{ steps.start.outputs.job_id }}
      post_id: ${{ steps.poll.outputs.post_id }}
      slug: ${{ steps.poll.outputs.slug }}
      title: ${{ steps.poll.outputs.title }}

    steps:
      - name: Start text generation
        id: start
        run: |
          TOPIC="${{ github.event.inputs.topic || 'auto' }}"
          MODEL="${{ github.event.inputs.model || 'claude-haiku' }}"

          echo "Starting blog post generation..."
          echo "  Topic: $TOPIC"
          echo "  Model: $MODEL"

          RESPONSE=$(curl -s --http1.1 -X POST \
            "${{ secrets.SITE_URL }}/api/pipeline/generate" \
            -H "Content-Type: application/json" \
            -H "x-pipeline-key: ${{ secrets.PIPELINE_SECRET }}" \
            -d "{\"type\": \"blog-post\", \"phase\": \"text\", \"topic\": \"$TOPIC\", \"model\": \"$MODEL\"}" \
            --max-time 30)

          echo "Response: $RESPONSE"

          JOB_ID=$(echo "$RESPONSE" | jq -r '.jobId // empty')
          if [ -z "$JOB_ID" ]; then
            echo "::error::No jobId in response"
            exit 1
          fi

          echo "job_id=$JOB_ID" >> "$GITHUB_OUTPUT"
          echo "Job started: $JOB_ID"

      - name: Poll for completion
        id: poll
        run: |
          JOB_ID="${{ steps.start.outputs.job_id }}"
          echo "Polling job $JOB_ID..."

          for i in $(seq 1 24); do
            sleep 10

            RESPONSE=$(curl -s --http1.1 -X POST \
              "${{ secrets.SITE_URL }}/api/pipeline/generate" \
              -H "Content-Type: application/json" \
              -H "x-pipeline-key: ${{ secrets.PIPELINE_SECRET }}" \
              -d "{\"type\": \"blog-post\", \"phase\": \"status\", \"jobId\": \"$JOB_ID\"}" \
              --max-time 15)

            STATUS=$(echo "$RESPONSE" | jq -r '.status // empty')
            echo "Attempt $i: status=$STATUS"

            if [ "$STATUS" = "completed" ]; then
              POST_ID=$(echo "$RESPONSE" | jq -r '.postId // empty')
              SLUG=$(echo "$RESPONSE" | jq -r '.slug // empty')
              TITLE=$(echo "$RESPONSE" | jq -r '.title // empty')

              echo "post_id=$POST_ID" >> "$GITHUB_OUTPUT"
              echo "slug=$SLUG" >> "$GITHUB_OUTPUT"
              echo "title=$TITLE" >> "$GITHUB_OUTPUT"
              echo "Text generated: $TITLE (ID: $POST_ID)"
              exit 0
            elif [ "$STATUS" = "failed" ]; then
              ERROR=$(echo "$RESPONSE" | jq -r '.error // "unknown"')
              echo "::error::Generation failed: $ERROR"
              exit 1
            fi
          done

          echo "::error::Generation timed out after 4 minutes"
          exit 1

  # Step 2: Generate images for the post
  generate-images:
    runs-on: ubuntu-latest
    needs: generate-text
    timeout-minutes: 5

    steps:
      - name: Generate featured image
        run: |
          POST_ID="${{ needs.generate-text.outputs.post_id }}"
          echo "Generating images for post $POST_ID..."

          RESPONSE=$(curl -s --http1.1 -w "\n%{http_code}" -X POST \
            "${{ secrets.SITE_URL }}/api/pipeline/generate" \
            -H "Content-Type: application/json" \
            -H "x-pipeline-key: ${{ secrets.PIPELINE_SECRET }}" \
            -d "{\"type\": \"blog-post\", \"phase\": \"images\", \"postId\": \"$POST_ID\"}" \
            --max-time 120)

          HTTP_CODE=$(echo "$RESPONSE" | tail -1)
          BODY=$(echo "$RESPONSE" | sed '$d')

          echo "Status: $HTTP_CODE"
          echo "$BODY"

          if [ "$HTTP_CODE" -ge 500 ]; then
            echo "::warning::Image generation failed ($HTTP_CODE) â€” post will publish without images"
          fi

  # Step 3: Publish the post
  publish-post:
    runs-on: ubuntu-latest
    needs: [generate-text, generate-images]
    if: github.event.inputs.publish == 'true' || github.event_name == 'schedule'
    timeout-minutes: 2

    steps:
      - name: Publish blog post
        run: |
          POST_ID="${{ needs.generate-text.outputs.post_id }}"
          echo "Publishing post $POST_ID..."

          RESPONSE=$(curl -s --http1.1 -X POST \
            "${{ secrets.SITE_URL }}/api/pipeline/generate" \
            -H "Content-Type: application/json" \
            -H "x-pipeline-key: ${{ secrets.PIPELINE_SECRET }}" \
            -d "{\"type\": \"blog-post\", \"phase\": \"publish\", \"postId\": \"$POST_ID\"}" \
            --max-time 30)

          echo "$RESPONSE"

          SLUG=$(echo "$RESPONSE" | jq -r '.slug // empty')
          TITLE=$(echo "$RESPONSE" | jq -r '.title // empty')
          PUBLISHED=$(echo "$RESPONSE" | jq -r '.published // false')

          if [ "$PUBLISHED" = "true" ]; then
            echo "Published: $TITLE"
            echo "URL: ${{ secrets.SITE_URL }}/blog/$SLUG"
          else
            echo "::error::Publish failed"
            exit 1
          fi

  # Health check
  health-check:
    runs-on: ubuntu-latest
    needs: [generate-text]
    if: always()
    timeout-minutes: 2

    steps:
      - name: Summary
        run: |
          echo "Title: ${{ needs.generate-text.outputs.title }}"
          echo "Slug: ${{ needs.generate-text.outputs.slug }}"
          echo "Post ID: ${{ needs.generate-text.outputs.post_id }}"
          echo "---"
          curl -s --http1.1 "${{ secrets.SITE_URL }}/api/pipeline/status" \
            -H "x-pipeline-key: ${{ secrets.PIPELINE_SECRET }}" \
            --max-time 30 | head -c 1000
