name: Weekly Blog Post Generation

on:
  schedule:
    # Every Monday at 08:00 UTC
    - cron: "0 8 * * 1"
  workflow_dispatch: # Allow manual trigger with options
    inputs:
      topic:
        description: "Blog post topic (leave empty for auto-select)"
        required: false
        default: "auto"
      model:
        description: "AI model to use"
        required: false
        default: "claude-haiku"
        type: choice
        options:
          - claude-haiku
          - gpt-5-nano
      publish:
        description: "Publish immediately?"
        required: false
        default: "false"
        type: choice
        options:
          - "false"
          - "true"

jobs:
  # Step 1: Generate blog post text via AI (~20-40s)
  generate-text:
    runs-on: ubuntu-latest
    timeout-minutes: 5
    outputs:
      post_id: ${{ steps.generate.outputs.post_id }}
      slug: ${{ steps.generate.outputs.slug }}
      title: ${{ steps.generate.outputs.title }}

    steps:
      - name: Generate blog post text
        id: generate
        run: |
          TOPIC="${{ github.event.inputs.topic || 'auto' }}"
          MODEL="${{ github.event.inputs.model || 'claude-haiku' }}"

          echo "Generating blog post text..."
          echo "  Topic: $TOPIC"
          echo "  Model: $MODEL"

          RESPONSE=$(curl -s -w "\n%{http_code}" -X POST \
            "${{ secrets.SITE_URL }}/api/pipeline/generate" \
            -H "Content-Type: application/json" \
            -H "x-pipeline-key: ${{ secrets.PIPELINE_SECRET }}" \
            -d "{\"type\": \"blog-post\", \"phase\": \"text\", \"topic\": \"$TOPIC\", \"model\": \"$MODEL\"}" \
            --max-time 120)

          HTTP_CODE=$(echo "$RESPONSE" | tail -1)
          BODY=$(echo "$RESPONSE" | sed '$d')

          echo "Status: $HTTP_CODE"
          echo "$BODY"

          if [ "$HTTP_CODE" -ge 400 ]; then
            echo "::error::Text generation failed with $HTTP_CODE"
            exit 1
          fi

          # Extract postId from JSON response
          POST_ID=$(echo "$BODY" | jq -r '.postId // empty')
          SLUG=$(echo "$BODY" | jq -r '.slug // empty')
          TITLE=$(echo "$BODY" | jq -r '.title // empty')

          if [ -z "$POST_ID" ]; then
            echo "::error::No postId in response"
            exit 1
          fi

          echo "post_id=$POST_ID" >> "$GITHUB_OUTPUT"
          echo "slug=$SLUG" >> "$GITHUB_OUTPUT"
          echo "title=$TITLE" >> "$GITHUB_OUTPUT"
          echo "Text generated: $TITLE (ID: $POST_ID)"

  # Step 2: Generate images for the post (~30-60s)
  generate-images:
    runs-on: ubuntu-latest
    needs: generate-text
    timeout-minutes: 5

    steps:
      - name: Generate images for post
        run: |
          POST_ID="${{ needs.generate-text.outputs.post_id }}"
          echo "Generating images for post $POST_ID..."

          RESPONSE=$(curl -s -w "\n%{http_code}" -X POST \
            "${{ secrets.SITE_URL }}/api/pipeline/generate" \
            -H "Content-Type: application/json" \
            -H "x-pipeline-key: ${{ secrets.PIPELINE_SECRET }}" \
            -d "{\"type\": \"blog-post\", \"phase\": \"images\", \"postId\": \"$POST_ID\"}" \
            --max-time 180)

          HTTP_CODE=$(echo "$RESPONSE" | tail -1)
          BODY=$(echo "$RESPONSE" | sed '$d')

          echo "Status: $HTTP_CODE"
          echo "$BODY"

          if [ "$HTTP_CODE" -ge 500 ]; then
            echo "::warning::Image generation failed with $HTTP_CODE (post will be published without images)"
          elif [ "$HTTP_CODE" -ge 400 ]; then
            echo "::warning::Image generation returned $HTTP_CODE"
          else
            echo "Images generated successfully!"
          fi

  # Step 3: Publish the post (~2s)
  publish-post:
    runs-on: ubuntu-latest
    needs: [generate-text, generate-images]
    if: github.event.inputs.publish == 'true' || github.event_name == 'schedule'
    timeout-minutes: 2

    steps:
      - name: Publish blog post
        run: |
          POST_ID="${{ needs.generate-text.outputs.post_id }}"
          echo "Publishing post $POST_ID..."

          RESPONSE=$(curl -s -w "\n%{http_code}" -X POST \
            "${{ secrets.SITE_URL }}/api/pipeline/generate" \
            -H "Content-Type: application/json" \
            -H "x-pipeline-key: ${{ secrets.PIPELINE_SECRET }}" \
            -d "{\"type\": \"blog-post\", \"phase\": \"publish\", \"postId\": \"$POST_ID\"}" \
            --max-time 30)

          HTTP_CODE=$(echo "$RESPONSE" | tail -1)
          BODY=$(echo "$RESPONSE" | sed '$d')

          echo "Status: $HTTP_CODE"
          echo "$BODY"

          if [ "$HTTP_CODE" -ge 400 ]; then
            echo "::error::Publish failed with $HTTP_CODE"
            exit 1
          fi

          SLUG=$(echo "$BODY" | jq -r '.slug // empty')
          TITLE=$(echo "$BODY" | jq -r '.title // empty')
          echo "Published: $TITLE"
          echo "URL: ${{ secrets.SITE_URL }}/blog/$SLUG"

  # Health check
  health-check:
    runs-on: ubuntu-latest
    needs: [generate-text, generate-images]
    if: always()
    timeout-minutes: 2

    steps:
      - name: Check pipeline status
        run: |
          echo "Post: ${{ needs.generate-text.outputs.title }}"
          echo "Slug: ${{ needs.generate-text.outputs.slug }}"
          echo "---"
          curl -s "${{ secrets.SITE_URL }}/api/pipeline/status" \
            -H "x-pipeline-key: ${{ secrets.PIPELINE_SECRET }}" \
            --max-time 30 | head -c 1000
